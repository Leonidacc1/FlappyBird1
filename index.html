<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Puggy Bird ‚Äî –∏–≥—Ä–∞ —Å –º–æ–ø—Å–æ–º –¥–ª—è Telegram</title>
  <style>
    :root{
      --bg: #0f172a; /* slate-900 */
      --fg: #e2e8f0; /* slate-200 */
      --accent: #22c55e; /* green-500 */
      --accent-2: #f59e0b; /* amber-500 */
      --danger: #ef4444; /* red-500 */
      --muted: #94a3b8; /* slate-400 */
      --panel: #111827cc; /* translucent */
    }
    html, body { margin: 0; height: 100%; background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      overscroll-behavior: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
    #wrap{ position:fixed; inset:0; display:grid; grid-template-rows: 1fr auto; }
    #game{ width:100%; height:100%; display:block; background: linear-gradient(#60a5fa,#93c5fd 50%, #fde68a 50.1%); }

    .hud{ position:fixed; left:0; right:0; top:0; padding: 10px 12px; display:flex; gap:8px; align-items:center; justify-content:space-between; pointer-events:none; }
    .hud .left, .hud .right { display:flex; gap:8px; align-items:center; }
    .chip{ pointer-events:auto; backdrop-filter: blur(6px); background: var(--panel); border:1px solid #1f2937; color:var(--fg);
           padding:8px 10px; border-radius:16px; font-weight:600; font-size:14px; display:inline-flex; align-items:center; gap:8px; }
    .btn{ pointer-events:auto; border:1px solid #1f2937; background:#111827; color:var(--fg); border-radius:14px; padding:8px 12px; font-weight:700; font-size:14px; cursor:pointer; }
    .btn[aria-pressed="true"]{ outline:2px solid var(--accent); }
    .btn:hover{ filter:brightness(1.1); }

    .controls{ position:fixed; left:0; right:0; bottom:12px; display:flex; justify-content:center; gap:10px; }
    .controls .btn{ background:#0b1220cc; backdrop-filter: blur(6px); }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:72px; background:#0b1220e6; color:var(--fg); border:1px solid #1f2937; padding:10px 14px; border-radius:14px; font-weight:600; opacity:0; transition:.3s opacity; pointer-events:none; }
    .toast.show{ opacity:1; }

    .card{ position:fixed; inset:0; display:grid; place-items:center; }
    .card .inner{ width:min(92vw, 480px); background:#0b1220cc; border:1px solid #1f2937; border-radius:20px; padding:16px; display:grid; gap:12px; text-align:center; backdrop-filter: blur(8px); }
    .title{ font-size:22px; font-weight:800; }
    .subtitle{ color:var(--muted); font-weight:600; }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .pill{ padding:8px 10px; border-radius:999px; border:1px solid #1f2937; background:#0b1220; font-weight:700; }

    /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ */
    #leaderboard{ position:fixed; inset:0; display:none; place-items:center; }
    #leaderboard .inner{ width:min(92vw, 520px); background:#0b1220cc; border:1px solid #1f2937; border-radius:20px; padding:16px; display:grid; gap:12px; text-align:left; backdrop-filter: blur(8px); }
    #lb-list{ max-height: 60vh; overflow:auto; border:1px solid #1f2937; border-radius:14px; }
    #lb-list table{ width:100%; border-collapse: collapse; font-weight:700; }
    #lb-list th, #lb-list td{ padding:10px 12px; border-bottom:1px solid #1f2937; }
    #lb-list tr.highlight{ background:#172036; }
    .lb-actions{ display:flex; gap:8px; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" role="img" aria-label="–ò–≥—Ä–∞ —Å –º–æ–ø—Å–æ–º: –ø—Ä–æ–ª–µ—Ç–∞–π —Å–∫–≤–æ–∑—å —Ç—Ä—É–±—ã"></canvas>
  </div>

  <div class="hud" aria-hidden="false">
    <div class="left">
      <div class="chip" id="scoreChip">üèÜ –°—á—ë—Ç: <span id="score">0</span></div>
      <div class="chip" id="bestChip">‚≠ê –†–µ–∫–æ—Ä–¥: <span id="best">0</span></div>
    </div>
    <div class="right">
      <button class="btn" id="pauseBtn" title="–ü–∞—É–∑–∞ (P)">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
      <button class="btn" id="modeBtn" aria-pressed="false" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (M)">üéÆ –†–µ–∂–∏–º: –¢–ê–ü</button>
      <button class="btn" id="soundBtn" aria-pressed="true" title="–ó–≤—É–∫ (S)">üîä –ó–≤—É–∫</button>
      <button class="btn" id="lbBtn" title="–õ–∏–¥–µ—Ä–±–æ—Ä–¥ (L)">üèÖ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="flapBtn" title="–ü—Ä—ã–≥–Ω—É—Ç—å (Space / ‚Üë / –¢–∞–ø)">‚¨ÜÔ∏è –ü—Ä—ã–≥–Ω—É—Ç—å</button>
    <button class="btn" id="startBtn" title="–°—Ç–∞—Ä—Ç / –†–µ—Å—Ç–∞—Ä—Ç (R)">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
  </div>

  <div class="toast" id="toast">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>

  <div class="card" id="overlay" hidden>
    <div class="inner">
      <div class="title" id="overlayTitle">Puggy Bird</div>
      <div class="subtitle" id="overlaySub">–¢–∞–ø–∞–π—Ç–µ —á—Ç–æ–±—ã –º–æ–ø—Å –≤–∑–ª–µ—Ç–∞–ª! –ò–∑–±–µ–≥–∞–π—Ç–µ —Ç—Ä—É–±.</div>
      <div class="row">
        <span class="pill">Space / ‚Üë / –¢–∞–ø ‚Äî –≤–∑–º–∞—Ö</span>
        <span class="pill">P ‚Äî –ø–∞—É–∑–∞</span>
        <span class="pill">M ‚Äî —Å–º–µ–Ω–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
        <span class="pill">L ‚Äî –ª–∏–¥–µ—Ä–±–æ—Ä–¥</span>
      </div>
      <div class="row">
        <button class="btn" id="playBtn">üöÄ –ò–≥—Ä–∞—Ç—å</button>
        <button class="btn" id="shareBtn" hidden>üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –æ—á–∫–∞–º–∏</button>
        <button class="btn" id="openLbBtn">üèÖ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ (–ª–æ–∫–∞–ª—å–Ω—ã–π + Telegram) -->
  <div id="leaderboard">
    <div class="inner">
      <div class="title">üèÖ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
      <div class="subtitle">–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram Game, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥.</div>
      <div id="lb-list"></div>
      <div class="lb-actions">
        <div>
          <button class="btn" id="lbRefresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn" id="lbShare">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
        <button class="btn" id="lbClose">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ó–∞–≥–æ—Ç–æ–≤–∫–∏ –∑–≤—É–∫–æ–≤ (–∑–∞–≥–ª—É—à–∫–∏ –≤ data: –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞) -->
  <audio id="sfxFlap" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA" type="audio/mpeg"></audio>
  <audio id="sfxScore" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA" type="audio/mpeg"></audio>
  <audio id="sfxHit" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA" type="audio/mpeg"></audio>

<script>
(function(){
  // === Telegram –∞–¥–∞–ø—Ç–∞—Ü–∏—è (WebApp + GameProxy) ===
  const TG = {
    webapp: (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null,
    game: window.TelegramGameProxy || (window.Telegram && window.Telegram.GameProxy) || null,
  };
  if (TG.webapp) { try { TG.webapp.expand(); TG.webapp.disableVerticalSwipes(); TG.webapp.ready(); } catch(e){} }

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã GameScore/Leaderboard —Å graceful fallback
  const GameBridge = {
    setScore(score, opts={}){
      try{
        // 1) –°—Ç–∞—Ä—ã–π GameProxy API
        if (TG.game && typeof TG.game.setScore === 'function') { TG.game.setScore(score, opts); return true; }
        if (TG.game && typeof TG.game.shareScore === 'function') { TG.game.shareScore(score); return true; }
        if (TG.game && typeof TG.game.postEvent === 'function') { TG.game.postEvent('set_score', score); return true; }
        // 2) WebApp invoke (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        if (TG.webapp && typeof TG.webapp.invoke === 'function') { TG.webapp.invoke('setGameScore', { score, force: !!opts.force }); return true; }
        // 3) –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É ‚Äî —Å–µ—Ä–≤–µ—Ä –≤—ã–∑–æ–≤–µ—Ç setGameScore
        if (TG.webapp && typeof TG.webapp.sendData === 'function') { TG.webapp.sendData(JSON.stringify({ type:'set_game_score', score, force: !!opts.force })); return true; }
      }catch(e){ console.warn('setScore error', e); }
      return false;
    },
    showLeaderboard(){
      try{
        if (TG.game && typeof TG.game.showLeaderboard === 'function') { TG.game.showLeaderboard(); return true; }
        if (TG.game && typeof TG.game.postEvent === 'function') { TG.game.postEvent('show_leaderboard'); return true; }
        if (TG.webapp && typeof TG.webapp.invoke === 'function') { TG.webapp.invoke('showLeaderboard', {}); return true; }
      }catch(e){ console.warn('showLeaderboard error', e); }
      return false;
    }
  };

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const lerp=(a,b,t)=>a+(b-a)*t;

  // === Canvas ===
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  let DPR = Math.max(1, Math.min(3, Math.floor(window.devicePixelRatio||1)));
  function resize(){ const {innerWidth:w, innerHeight:h} = window; DPR = Math.max(1, Math.min(3, Math.floor(window.devicePixelRatio||1))); cvs.width = Math.floor(w*DPR); cvs.height = Math.floor(h*DPR); cvs.style.width = w+'px'; cvs.style.height = h+'px'; }
  window.addEventListener('resize', resize, {passive:true}); resize();

  // === –ó–≤—É–∫ ===
  const sfx = { flap: document.getElementById('sfxFlap'), score: document.getElementById('sfxScore'), hit: document.getElementById('sfxHit') };
  let soundOn = true; const playSfx = (a)=>{ if(!soundOn) return; try{ a.currentTime=0; a.play().catch(()=>{});}catch(e){} };

  // === UI ===
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const pauseBtn = document.getElementById('pauseBtn');
  const modeBtn = document.getElementById('modeBtn');
  const soundBtn = document.getElementById('soundBtn');
  const flapBtn = document.getElementById('flapBtn');
  const startBtn = document.getElementById('startBtn');
  const overlay = document.getElementById('overlay');
  const overlayTitle = document.getElementById('overlayTitle');
  const overlaySub = document.getElementById('overlaySub');
  const playBtn = document.getElementById('playBtn');
  const shareBtn = document.getElementById('shareBtn');
  const toast = document.getElementById('toast');
  const lbBtn = document.getElementById('lbBtn');
  const openLbBtn = document.getElementById('openLbBtn');

  // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ UI
  const lbModal = document.getElementById('leaderboard');
  const lbList = document.getElementById('lb-list');
  const lbClose = document.getElementById('lbClose');
  const lbRefresh = document.getElementById('lbRefresh');
  const lbShare = document.getElementById('lbShare');

  // === –•—Ä–∞–Ω–∏–ª–∏—â–µ ===
  const store = { get k(){return 'puggybird:v2';}, load(){ try{ return JSON.parse(localStorage.getItem(this.k))||{} }catch(e){ return {} } }, save(v){ try{ localStorage.setItem(this.k, JSON.stringify(v)); }catch(e){} } };
  let saved = store.load();
  let best = saved.best|0; bestEl.textContent = best;
  soundOn = saved.sound!==false; soundBtn.setAttribute('aria-pressed', soundOn);
  let controlMode = saved.mode||'tap';
  updateModeBtn();

  function showToast(text, ms=1400){ toast.textContent = text; toast.classList.add('show'); clearTimeout(showToast.tid); showToast.tid = setTimeout(()=> toast.classList.remove('show'), ms); }
  function updateModeBtn(){ modeBtn.textContent = controlMode==='tap' ? 'üéÆ –†–µ–∂–∏–º: –¢–ê–ü' : 'üéÆ –†–µ–∂–∏–º: –£–î–ï–†–ñ–ê–ù–ò–ï'; modeBtn.setAttribute('aria-pressed', controlMode==='hold'); }

  // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã ===
  const G = 1800; const FLAP = 520; const HOLD_THRUST = 360; const MAX_VY = 900; let baseSpeed = 190; let gap = 220; const pug = { x:0,y:0,r:22,vy:0,rot:0 };

  // === –°–æ—Å—Ç–æ—è–Ω–∏–µ ===
  let state = 'ready'; // ready | playing | paused | gameover
  let pipes = []; let tLast = 0; let acc = 0; let score = 0; let world = { w:0,h:0,ground:0 };

  function reset(){ const w=cvs.width, h=cvs.height; world.w=w; world.h=h; world.ground = Math.round(h*0.82); pug.x = Math.round(w*0.28); pug.y = Math.round(h*0.42); pug.vy=0; pug.rot=0; pipes.length=0; acc=0; score=0; scoreEl.textContent=score; baseSpeed = 190; gap = clamp(Math.round(h/3.2), 180, 260); }

  function spawnPipe(){ const w = Math.max(80, Math.round(world.w*0.17)); const x = world.w + w; const minY = 120*DPR, maxY = world.ground - 140*DPR; const y = Math.round(rand(minY+60, maxY-60)); pipes.push({ x, w, gapY:y, passed:false }); }

  function flap(){ pug.vy = -FLAP; playSfx(sfx.flap); }
  function togglePause(){ if(state==='playing'){ state='paused'; overlay.hidden=false; overlayTitle.textContent='–ü–∞—É–∑–∞'; overlaySub.textContent='–ù–∞–∂–º–∏—Ç–µ –ò–≥—Ä–∞—Ç—å –∏–ª–∏ P —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å'; } else if(state==='paused'){ state='playing'; overlay.hidden=true; } }
  function setState(newState){ state=newState; if(state==='ready'){ overlay.hidden=false; overlayTitle.textContent='Puggy Bird'; overlaySub.textContent='–¢–∞–ø–∞–π—Ç–µ/Space —á—Ç–æ–±—ã –º–æ–ø—Å –≤–∑–ª–µ—Ç–∞–ª. –ü—Ä–æ–ª–µ—Ç–∞–π—Ç–µ —á–µ—Ä–µ–∑ —Ç—Ä—É–±—ã.'; shareBtn.hidden=true; } else if(state==='gameover'){ overlay.hidden=false; overlayTitle.textContent='–ü–æ—Ä–∞–∂–µ–Ω–∏–µ'; overlaySub.textContent=`–°—á—ë—Ç: ${score} ‚Äî —Ä–µ–∫–æ—Ä–¥: ${best}`; shareBtn.hidden=false; playSfx(sfx.hit); } else if(state==='playing'){ overlay.hidden=true; } }

  function drawBackground(){ const w=world.w,h=world.h,g=world.ground; ctx.fillStyle = '#fde68a'; ctx.fillRect(0,g,w,h-g); ctx.fillStyle = '#65a30d'; for(let i=0;i<w;i+=40*DPR){ ctx.beginPath(); ctx.ellipse(i+20*DPR, g-8*DPR, 24*DPR, 10*DPR, 0, 0, Math.PI*2); ctx.fill(); } }
  function drawPipe(p){ const topH = p.gapY - gap/2; const botY = p.gapY + gap/2; ctx.fillStyle = '#10b981'; ctx.fillRect(p.x, 0, p.w, topH); ctx.fillRect(p.x, botY, p.w, world.h-botY); ctx.fillStyle = '#059669'; ctx.fillRect(p.x-2*DPR, topH-16*DPR, p.w+4*DPR, 16*DPR); ctx.fillRect(p.x-2*DPR, botY, p.w+4*DPR, 16*DPR); }
  function drawPug(){ const x=pug.x, y=pug.y, r=pug.r*DPR; ctx.save(); ctx.translate(x,y); ctx.rotate(pug.rot); ctx.fillStyle = '#b08968'; ctx.beginPath(); ctx.ellipse(0,0, r*1.1, r*0.9, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#d4a373'; ctx.beginPath(); ctx.arc(r*0.2, -r*0.2, r*0.9, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#4b3f35'; ctx.beginPath(); ctx.arc(-r*0.2, -r*0.9, r*0.35, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(r*0.6, -r*0.95, r*0.35, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#6d4c41'; ctx.beginPath(); ctx.ellipse(r*0.4, -r*0.05, r*0.6, r*0.4, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#2b2b2b'; ctx.beginPath(); ctx.arc(r*0.2, -r*0.05, r*0.07, 0, Math.PI*2); ctx.arc(r*0.6, -r*0.05, r*0.07, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -r*0.25, r*0.18, 0, Math.PI*2); ctx.arc(r*0.5, -r*0.25, r*0.18, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(0, -r*0.25, r*0.09, 0, Math.PI*2); ctx.arc(r*0.5, -r*0.25, r*0.09, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#b08968'; ctx.lineWidth = 4*DPR; ctx.beginPath(); ctx.arc(-r*1.1, r*0.1, r*0.5, Math.PI*0.2, Math.PI*1.2); ctx.stroke(); const t = (performance.now()/200)%1; const flap = Math.sin(t*Math.PI*2)*0.4; ctx.fillStyle = '#e0c9a6'; ctx.save(); ctx.translate(-r*0.4, 0); ctx.rotate(-0.8+flap); ctx.beginPath(); ctx.ellipse(0,0, r*0.7, r*0.35, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); ctx.restore(); }

  function update(dt){ if(state!=='playing') return; baseSpeed = Math.min(360, baseSpeed + dt*1.5); if(input.flap){ flap(); input.flap=false; } if(controlMode==='hold' && input.hold){ pug.vy -= HOLD_THRUST*dt; } pug.vy += G*dt; pug.vy = clamp(pug.vy, -MAX_VY, MAX_VY); pug.y += pug.vy*dt; pug.rot = lerp(pug.rot, clamp(pug.vy/800, -0.6, 1.0), 0.15); if(pug.y - pug.r*DPR < 0){ pug.y = pug.r*DPR; pug.vy = 0; } acc += dt; if(acc > rand(1.05, 1.35)) { acc=0; spawnPipe(); } for(const p of pipes){ p.x -= baseSpeed*DPR*dt; } for(let i=pipes.length-1;i>=0;i--){ const p=pipes[i]; if(!p.passed && p.x + p.w < pug.x){ p.passed=true; score++; scoreEl.textContent=score; playSfx(sfx.score); } if(p.x + p.w < -10*DPR){ pipes.splice(i,1); } } if(checkCollision()){ gameOver(); } if(pug.y + pug.r*DPR > world.ground){ pug.y = world.ground - pug.r*DPR; gameOver(); } }

  function checkCollision(){ for(const p of pipes){ const topH = p.gapY - gap/2; const botY = p.gapY + gap/2; if(circleRect(pug.x, pug.y, pug.r*DPR, p.x, 0, p.w, topH)) return true; if(circleRect(pug.x, pug.y, pug.r*DPR, p.x, botY, p.w, world.h-botY)) return true; } return false; }
  function circleRect(cx,cy,r, rx,ry,rw,rh){ const dx = Math.abs(cx - (rx + rw/2)); const dy = Math.abs(cy - (ry + rh/2)); const clx = Math.max(dx - rw/2, 0); const cly = Math.max(dy - rh/2, 0); return (clx*clx + cly*cly) <= r*r; }

  function gameOver(){ if(state!=='playing') return; setState('gameover'); if(score>best){ best=score; bestEl.textContent=best; saved.best=best; store.save(saved); } // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –æ—á–∫–∏ –≤ Telegram GameScore
    const ok = GameBridge.setScore(score, {force:true}); if(ok){ showToast('–û—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram'); }
  }

  function draw(){ ctx.clearRect(0,0,world.w,world.h); drawBackground(); for(const p of pipes){ drawPipe(p); } drawPug(); ctx.save(); ctx.font = `${48*DPR}px ui-sans-serif, system-ui, -apple-system, Segoe UI`; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle='#0008'; ctx.fillText(score, world.w/2 + 2*DPR, 16*DPR + 2*DPR); ctx.fillStyle='#fff'; ctx.fillText(score, world.w/2, 16*DPR); ctx.restore(); }

  function loop(t){ if(!tLast) tLast = t; const dt = Math.min(0.033, (t - tLast)/1000); tLast = t; update(dt); draw(); requestAnimationFrame(loop); }

  // === –í–≤–æ–¥ ===
  const input = { flap:false, hold:false };
  function onFlap(){ input.flap=true; }
  function onHold(v){ input.hold=v; }

  cvs.addEventListener('pointerdown', (e)=>{ if(state==='ready'){ startGame(); } onFlap(); onHold(true); }, {passive:false});
  window.addEventListener('pointerup', ()=> onHold(false), {passive:true});

  window.addEventListener('keydown', (e)=>{ if(e.repeat) return; const k = e.key.toLowerCase(); if(k===' '||k==='arrowup'||k==='w'){ if(state==='ready'){ startGame(); } onFlap(); onHold(true); e.preventDefault(); } if(k==='p'){ togglePause(); } if(k==='m'){ toggleMode(); } if(k==='s'){ toggleSound(); } if(k==='r'){ if(state==='gameover'||state==='paused'){ startGame(); } } if(k==='l'){ openLeaderboard(); }
  });
  window.addEventListener('keyup', (e)=>{ const k = e.key.toLowerCase(); if(k===' '||k==='arrowup'||k==='w'){ onHold(false); } });

  flapBtn.addEventListener('click', ()=>{ if(state==='ready'){ startGame(); } onFlap(); });
  startBtn.addEventListener('click', ()=> startGame());
  pauseBtn.addEventListener('click', togglePause);
  modeBtn.addEventListener('click', toggleMode);
  soundBtn.addEventListener('click', toggleSound);
  playBtn.addEventListener('click', ()=>{ if(state==='paused'){ togglePause(); } else startGame(); });
  shareBtn.addEventListener('click', shareScore);
  lbBtn.addEventListener('click', openLeaderboard);
  openLbBtn.addEventListener('click', openLeaderboard);

  function toggleMode(){ controlMode = controlMode==='tap' ? 'hold' : 'tap'; saved.mode = controlMode; store.save(saved); updateModeBtn(); showToast(controlMode==='tap' ? '–†–µ–∂–∏–º –¢–ê–ü' : '–†–µ–∂–∏–º –£–î–ï–†–ñ–ê–ù–ò–ï'); }
  function toggleSound(){ soundOn = !soundOn; saved.sound = soundOn; store.save(saved); soundBtn.textContent = soundOn ? 'üîä –ó–≤—É–∫' : 'üîá –ë–µ–∑ –∑–≤—É–∫–∞'; soundBtn.setAttribute('aria-pressed', soundOn); }

  function startGame(){ reset(); setState('playing'); showToast(controlMode==='tap' ? '–¢–∞–ø–∞–π—Ç–µ –∏–ª–∏ –∂–º–∏—Ç–µ Space' : '–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ–¥—ä—ë–º–∞'); }

  function shareScore(){ const payload = JSON.stringify({ type:'puggybird_score', score, best }); if(TG.webapp){ try{ TG.webapp.sendData(payload); }catch(e){} } GameBridge.setScore(score, {force:true}); showToast('–°—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'); }

  // === –õ–∏–¥–µ—Ä–±–æ—Ä–¥ ===
  function openLeaderboard(){
    // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ Telegram
    const nativeShown = GameBridge.showLeaderboard();
    if(nativeShown) return;
    // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ (–∏–ª–∏ —Ç–æ—Ç, —á—Ç–æ –ø—Ä–∏—à—ë–ª –æ—Ç –±–æ—Ç–∞)
    renderLocalLeaderboard();
    lbModal.style.display='grid';
  }
  function closeLeaderboard(){ lbModal.style.display='none'; }

  function renderLocalLeaderboard(items){
    // items ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π {name, score, me}
    let rows = items;
    if(!rows){
      // –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–ª–±–µ–∫: –±–µ—Ä—ë–º –∏–∑ localStorage –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
      const me = (TG.webapp && TG.webapp.initDataUnsafe && TG.webapp.initDataUnsafe.user) ? TG.webapp.initDataUnsafe.user : null;
      rows = [{ rank:1, name: me ? (me.username || `${me.first_name||''} ${me.last_name||''}`.trim() || '–í—ã') : '–í—ã', score: best, me:true }];
    }
    // –ù–æ—Ä–º–∏—Ä—É–µ–º + —Å–æ—Ä—Ç–∏—Ä—É–µ–º
    rows = rows.map((r,i)=>({ rank: r.rank || i+1, name: r.name || '–ò–≥—Ä–æ–∫', score: r.score|0, me: !!r.me }))
               .sort((a,b)=> b.score - a.score).slice(0,100);

    let html = '<table><thead><tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th style="text-align:right">–û—á–∫–∏</th></tr></thead><tbody>';
    rows.forEach((r,i)=>{
      html += `<tr class="${r.me?'highlight':''}"><td>${r.rank||i+1}</td><td>${escapeHtml(r.name)}</td><td style="text-align:right">${r.score}</td></tr>`;
    });
    html += '</tbody></table>';
    lbList.innerHTML = html;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  lbClose.addEventListener('click', closeLeaderboard);
  lbRefresh.addEventListener('click', ()=>{
    // –ü–æ–ø—Ä–æ—Å–∏–º –±–æ—Ç–∞ –ø—Ä–∏—Å–ª–∞—Ç—å —Å–≤–µ–∂–∏–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
    if(TG.webapp && typeof TG.webapp.sendData==='function'){
      TG.webapp.sendData(JSON.stringify({type:'get_leaderboard'}));
    }
  });
  lbShare.addEventListener('click', ()=> shareScore());

  // –ü—Ä–∏—ë–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–æ—Ç–∞ (—á–µ—Ä–µ–∑ WebAppData)
  if (TG.webapp && typeof TG.webapp.onEvent==='function'){
    TG.webapp.onEvent('web_app_data', function(){
      try{
        const raw = TG.webapp.initDataUnsafe && TG.webapp.initDataUnsafe?.query_id ? TG.webapp.initDataUnsafe : null;
        // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∫–ª–∞–¥—É—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ WebApp.initDataUnsafe, –Ω–æ –Ω–∞–¥—ë–∂–Ω–µ–µ —á–∏—Ç–∞—Ç—å –∏–∑ —Å–æ–±—ã—Ç–∏—è web_app_data
        // –û–¥–Ω–∞–∫–æ SDK –≤ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –≤–µ–¥—ë—Ç —Å–µ–±—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É, –ø–æ—ç—Ç–æ–º—É —á–∏—Ç–∞–µ–º –∏–∑ clipboard-like API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
      }catch(e){}
    });
  }
  // –¢–∞–∫–∂–µ —Å–ª—É—à–∞–µ–º window message (–µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ —à–ª—ë—Ç postMessage –∏–∑ WebView)
  window.addEventListener('message', (ev)=>{
    try{
      const data = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
      if(data && data.type==='leaderboard' && Array.isArray(data.items)){
        renderLocalLeaderboard(data.items);
        lbModal.style.display='grid';
      }
    }catch(e){}
  });

  // –°—Ç–∞—Ä—Ç
  reset(); setState('ready'); requestAnimationFrame(loop);
})();
</script>
</body>
</html>
