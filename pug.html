<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <title>Puggy Bird ‚Äî –ú–æ–ø—Å –ø—Ä–æ—Ç–∏–≤ —Ç—Ä—É–±</title>
  <style>
    :root{
      --sky1:#8ec5ff; --sky2:#c7e7ff;
      --panel:#0b1220cc; --panel-solid:#0b1220; --br:#1f2937; --txt:#eaf2fb; --muted:#a4b8ce;
    }
    html,body{height:100%;margin:0;background:linear-gradient(var(--sky1),var(--sky2));color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;overscroll-behavior:none;touch-action:none}
    #wrap{position:fixed;inset:0}
    canvas{display:block;width:100%;height:100%}

    .hud{position:fixed;left:0;right:0;top:10px;display:flex;justify-content:space-between;align-items:center;padding:0 12px;pointer-events:none;z-index:5}
    .chip{pointer-events:auto;background:var(--panel);border:1px solid var(--br);backdrop-filter:blur(6px);border-radius:16px;padding:8px 10px;font-weight:800;display:inline-flex;gap:8px;align-items:center}
    .btn{pointer-events:auto;background:var(--panel-solid);border:1px solid var(--br);color:var(--txt);border-radius:14px;padding:8px 12px;font-weight:800;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* Overlay menu */
    #overlay{position:fixed;inset:0;display:grid;place-items:center;z-index:10}
    #overlay.hidden{display:none}
    #overlay .inner{width:min(92vw,520px);background:var(--panel);border:1px solid var(--br);border-radius:20px;padding:16px;display:grid;gap:12px;text-align:center;backdrop-filter:blur(8px)}
    .title{font-size:24px;font-weight:900}
    .subtitle{color:var(--muted);font-weight:700}

    /* Shop */
    #shop{position:fixed;inset:0;display:none;place-items:center;z-index:20}
    #shop.show{display:grid}
    #shop .inner{width:min(92vw,560px);background:var(--panel);border:1px solid var(--br);border-radius:20px;padding:16px;display:grid;gap:12px;text-align:center}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .card{background:var(--panel-solid);border:1px solid var(--br);border-radius:16px;padding:10px;display:grid;gap:8px}
    .price{display:flex;align-items:center;gap:6px;color:#ffd089;font-weight:900;justify-content:flex-end}

    /* Leaderboard fallback (optional panel) */
    #lb{position:fixed;inset:0;display:none;place-items:center;z-index:20}
    #lb.show{display:grid}
    #lb .inner{width:min(92vw,520px);background:var(--panel);border:1px solid var(--br);border-radius:20px;padding:16px}
    #lb table{width:100%;border-collapse:collapse}
    #lb th,#lb td{padding:10px 12px;border-bottom:1px solid var(--br);font-weight:700;text-align:left}
  </style>
</head>
<body>
  <div id="wrap"><canvas id="game" aria-label="–ú–æ–ø—Å –ø—Ä–æ–ª–µ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —Ç—Ä—É–±—ã –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –µ–¥—É"></canvas></div>

  <div class="hud">
    <div class="left">
      <span class="chip">üèÜ –°—á—ë—Ç: <span id="score">0</span></span>
      <span class="chip">‚≠ê –†–µ–∫–æ—Ä–¥: <span id="best">0</span></span>
      <span class="chip">üçñ –ï–¥–∞: <span id="food">0</span></span>
    </div>
    <div class="right" style="display:flex;gap:8px">
      <button class="btn" id="pauseBtn">‚è∏Ô∏è</button>
      <button class="btn" id="modeBtn">üéÆ –¢–ê–ü</button>
      <button class="btn" id="soundBtn">üîä</button>
      <button class="btn" id="shopBtn">üõçÔ∏è</button>
    </div>
  </div>

  <div id="overlay">
    <div class="inner">
      <div class="title">Puggy Bird</div>
      <div class="subtitle">–¢–∞–ø–Ω–∏—Ç–µ ¬´–ò–≥—Ä–∞—Ç—å¬ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–µ–ª</div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="playBtn">üöÄ –ò–≥—Ä–∞—Ç—å</button>
        <button class="btn" id="openShopBtn">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
      </div>
    </div>
  </div>

  <div id="shop">
    <div class="inner">
      <div class="title">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</div>
      <div class="subtitle">–ü–æ–∫—É–ø–∞–π –∑–∞ –µ–¥—É üçñ. –°–∫–∏–Ω—ã ‚Äî –∫–æ—Å–º–µ—Ç–∏–∫–∞.</div>
      <div class="grid" id="skins"></div>
      <div style="display:flex;justify-content:center;gap:10px">
        <button class="btn" id="closeShop">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="lb">
    <div class="inner">
      <div class="title">üèÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥</div>
      <div id="lbList"></div>
      <div style="display:flex;justify-content:center;gap:10px;margin-top:8px">
        <button class="btn" id="lbClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');

  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const foodEl = document.getElementById('food');
  const pauseBtn = document.getElementById('pauseBtn');
  const modeBtn = document.getElementById('modeBtn');
  const soundBtn = document.getElementById('soundBtn');
  const shopBtn = document.getElementById('shopBtn');
  const overlay = document.getElementById('overlay');
  const playBtn = document.getElementById('playBtn');
  const openShopBtn = document.getElementById('openShopBtn');
  const shop = document.getElementById('shop');
  const skinsGrid = document.getElementById('skins');
  const closeShop = document.getElementById('closeShop');
  const lb = document.getElementById('lb');
  const lbList = document.getElementById('lbList');
  const lbClose = document.getElementById('lbClose');

  let DPR=1, W=0, H=0, GROUND=0;
  let tPrev=0; let state='ready';

  const storeKey='puggybird:v5';
  function load(){ try{return JSON.parse(localStorage.getItem(storeKey))||{};}catch(e){return {}} }
  function save(o){ try{localStorage.setItem(storeKey,JSON.stringify(o));}catch(e){} }
  let data=load();
  let best=data.best|0; let food=data.food|0; let soundOn=data.sound!==false; let mode=data.mode||'tap'; let selectedSkin=data.skin||'classic'; data.inv=data.inv||{classic:true};
  bestEl.textContent=best; foodEl.textContent=food; soundBtn.textContent=soundOn?'üîä':'üîá'; modeBtn.textContent=mode==='tap'?'üéÆ –¢–ê–ü':'üéÆ –£–î–ï–†–ñ–ê–ù–ò–ï';

  const AC = window.AudioContext||window.webkitAudioContext; const audio=AC?new AC():null;
  function tone(freq=700,dur=0.07,type='square',vol=0.18){ if(!audio||!soundOn) return; const t=audio.currentTime; const o=audio.createOscillator(); const g=audio.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audio.destination); o.start(t); o.stop(t+dur); }
  const sfx={ flap:()=>tone(900,0.08,'square',0.15), score:()=>tone(650,0.08,'triangle',0.2), food:()=>tone(520,0.09,'sine',0.23), hit:()=>tone(160,0.25,'sawtooth',0.35) };

  const PUG={ x:0,y:0,r:22,vy:0,rot:0 };
  let pipes=[]; let kibble=[];
  let score=0; let gap=320; let spacing=480; let speed=150;
  const GRAV=2200, FLAP=560, HOLD=400, MAXV=900;

  function resize(){
    DPR=Math.max(1,Math.min(3,Math.floor(devicePixelRatio||1)));
    W=innerWidth; H=innerHeight; cvs.width=W*DPR; cvs.height=H*DPR; cvs.style.width=W+'px'; cvs.style.height=H+'px'; ctx.setTransform(DPR,0,0,DPR,0,0);
    GROUND=Math.round(H*0.82); spacing=Math.round(Math.max(W*0.5, 360)); gap=Math.round(Math.max(H*0.38, 300)); speed=140+Math.min(80,W/18);
    if(state!=='playing') reset(false);
  }
  addEventListener('resize', resize, {passive:true});

  function reset(keepState){
    PUG.x=Math.round(W*0.28); PUG.y=Math.round(H*0.42); PUG.vy=0; PUG.rot=0;
    pipes.length=0; kibble.length=0; score=0; scoreEl.textContent=score;
    spawnPipe(true);
    if(!keepState) setState('ready');
  }

  function setState(s){ state=s; overlay.classList.toggle('hidden', s==='playing'); }

  function rightmost(){ return pipes.length? pipes[pipes.length-1]:null; }

  function spawnPipe(initial){
    const w=Math.max(80, Math.round(W*0.18));
    const last=rightmost();
    const x = initial? (W + w) : Math.max(W + w, last.x + last.w + spacing);
    const minY=140, maxY=GROUND-160; const mid = Math.round(minY + Math.random()*(maxY-minY));
    pipes.push({x,w,mid,passed:false});
    const fx=x+Math.max(120,w*0.7); const fy=mid + (Math.random()*2-1)*gap*0.22; kibble.push({x:fx,y:fy,r:12,t:false});
  }

  function ensurePipe(){ const last=rightmost(); if(!last || last.x + last.w < W - spacing) spawnPipe(false); }

  function applyDifficulty(dt){ speed=Math.min(360, speed + dt*0.9); gap=Math.max(220, gap - dt*4.5); }

  function update(dt){ if(state!=='playing') return; applyDifficulty(dt);
    if(input.flap){ PUG.vy=-FLAP; sfx.flap(); input.flap=false; }
    if(mode==='hold' && input.hold) PUG.vy -= HOLD*dt;
    PUG.vy+=GRAV*dt; PUG.vy=Math.max(-MAXV,Math.min(MAXV,PUG.vy)); PUG.y+=PUG.vy*dt; PUG.rot=PUG.vy/800;
    if(PUG.y-PUG.r<0){ PUG.y=PUG.r; PUG.vy=0; }

    ensurePipe();
    const vx=speed*dt;
    for(const p of pipes) p.x -= vx;
    for(const f of kibble) f.x -= vx;

    for(let i=pipes.length-1;i>=0;i--){ const p=pipes[i];
      if(!p.passed && p.x+p.w<PUG.x){ p.passed=true; score++; scoreEl.textContent=score; food++; foodEl.textContent=food; data.food=food; save(data); sfx.score(); }
      if(p.x+p.w<-40) pipes.splice(i,1);
    }
    for(let i=kibble.length-1;i>=0;i--){ const f=kibble[i]; if(f.t||f.x<-30){ kibble.splice(i,1); continue; } if(circle(PUG.x,PUG.y,PUG.r, f.x,f.y,f.r)){ f.t=true; kibble.splice(i,1); food+=5; foodEl.textContent=food; data.food=food; save(data); sfx.food(); } }

    if(collide()){ gameOver(); }
    if(PUG.y+PUG.r>GROUND){ PUG.y=GROUND-PUG.r; gameOver(); }
  }

  function collide(){ for(const p of pipes){ const topH=p.mid-gap/2; const botY=p.mid+gap/2; if(circleRect(PUG.x,PUG.y,PUG.r, p.x,0,p.w,topH)) return true; if(circleRect(PUG.x,PUG.y,PUG.r, p.x,botY,p.w,H-botY)) return true; } return false; }
  function circleRect(cx,cy,cr, rx,ry,rw,rh){ const dx=Math.abs(cx-(rx+rw/2)); const dy=Math.abs(cy-(ry+rh/2)); const clx=Math.max(dx-rw/2,0); const cly=Math.max(dy-rh/2,0); return clx*clx+cly*cly<=cr*cr; }
  function circle(ax,ay,ar, bx,by,br){ const dx=ax-bx,dy=ay-by; return dx*dx+dy*dy <= (ar+br)*(ar+br); }

  function draw(t){
    drawBg(t);
    for(const p of pipes) drawPipe(p);
    for(const f of kibble) drawFood(f,t);
    drawPug(t);
    ctx.save(); ctx.font='46px system-ui, -apple-system, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle='#0006'; ctx.fillText(score, W/2+2, 14+2); ctx.fillStyle='#fff'; ctx.fillText(score, W/2, 14); ctx.restore();
  }

  function drawBg(t){
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#8ec5ff'); g.addColorStop(1,'#c7e7ff'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    const heartSize=Math.min(W,H)*0.42; const heartY = H*0.43; ctx.save(); drawHeart(W*0.52, heartY, heartSize, 0, '#ff0000', '#7a0000'); ctx.restore();
    ctx.save(); ctx.shadowColor='#0006'; ctx.shadowBlur=8; const fsz=Math.round(Math.min(W, H)*0.07); ctx.font=`${fsz}px 'Pacifico', cursive`; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillStyle='#ffffff'; ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=4; const msg='–û–ª–∏–≤–∫–∞, —ç—Ç–æ –æ—Ç–¥—ã—Ö –æ—Ç —Ä–∏–ª—Å–∏–∫–æ–≤'; const ty = heartY - heartSize*0.64; ctx.strokeText(msg, W/2, ty); ctx.fillText(msg, W/2, ty); ctx.restore();
    ctx.fillStyle='#7fb1e6'; const cityY=H*0.7; for(let i=0;i<W;i+=90){ const bw=50, bh=(Math.sin((t*0.00025+i)*0.6)*0.2+0.8)*80; ctx.fillRect((i - (t*0.03)%(W+120)), cityY-bh, bw, bh); }
    ctx.fillStyle='#6aa0da'; for(let i=0;i<W;i+=120){ const bw=60, bh=(Math.cos((t*0.0002+i)*0.5)*0.2+0.9)*110; ctx.fillRect((i - (t*0.04)%(W+150)), cityY-bh, bw, bh); }
    ctx.save(); ctx.globalAlpha=0.9; ctx.fillStyle='#fff'; for(let i=0;i<4;i++){ const cx=((t*0.02)+i*W/4)%(W+200)-100; const cy=100 + i*18; cloud(cx,cy); } ctx.restore();
    const gg=ctx.createLinearGradient(0,GROUND,0,H); gg.addColorStop(0,'#ffe092'); gg.addColorStop(1,'#ffd27a'); ctx.fillStyle=gg; ctx.fillRect(0,GROUND,W,H-GROUND);
    ctx.fillStyle='#b7e56a'; for(let i=0;i<W;i+=40){ ctx.beginPath(); ctx.ellipse(i+20,GROUND-8,24,10,0,0,Math.PI*2); ctx.fill(); }
  }
  function cloud(x,y){ ctx.beginPath(); ctx.ellipse(x,y,48,22,0,0,Math.PI*2); ctx.ellipse(x+30,y+4,26,16,0,0,Math.PI*2); ctx.ellipse(x-28,y+8,30,18,0,0,Math.PI*2); ctx.fill(); }
  function drawHeart(cx,cy,s,rot,fill,stroke){ ctx.save(); ctx.translate(cx,cy); ctx.rotate(rot); ctx.beginPath(); const k=s*0.25; ctx.moveTo(0,-k*0.2); ctx.bezierCurveTo(k*2,-k*1.6, k*2.4,k*1.0, 0,k*2.2); ctx.bezierCurveTo(-k*2.4,k*1.0, -k*2,-k*1.6, 0,-k*0.2); ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); if(stroke){ ctx.lineWidth=Math.max(2,s*0.02); ctx.strokeStyle=stroke; ctx.stroke(); } ctx.restore(); }

  function drawPipe(p){ const topH=p.mid-gap/2; const botY=p.mid+gap/2; const w=p.w; const x=p.x; const grad=ctx.createLinearGradient(x,0,x+w,0); grad.addColorStop(0,'#0ea5a3'); grad.addColorStop(1,'#10b981'); ctx.fillStyle=grad; ctx.fillRect(x,0,w,topH); ctx.fillRect(x,botY,w,H-botY); ctx.fillStyle='#047857'; ctx.fillRect(x-2,topH-20,w+4,20); ctx.fillRect(x-2,botY,w+4,20); ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.fillRect(x+2,topH-2,w-4,2); ctx.fillRect(x+2,botY+20,w-4,2); }

  function drawFood(f,t){ const s=1+Math.sin(t*0.01+f.x*0.02)*0.05; ctx.save(); ctx.translate(f.x,f.y); ctx.scale(s,s); ctx.fillStyle='#ffcc7a'; ctx.beginPath(); ctx.arc(-10,-6,6,0,Math.PI*2); ctx.arc(10,-6,6,0,Math.PI*2); ctx.arc(-10,6,6,0,Math.PI*2); ctx.arc(10,6,6,0,Math.PI*2); ctx.fill(); ctx.fillRect(-10,-8,20,16); ctx.restore(); }

  function drawPug(){ const x=PUG.x,y=PUG.y,r=PUG.r; ctx.save(); ctx.translate(x,y); ctx.rotate(PUG.rot); const t=performance.now()/200; const flap=Math.sin(t*2*Math.PI)*0.4; let body='#b08968', snout='#6d4c41', ear='#4b3f35', deco=null; if(selectedSkin==='bee'){ body='#f6d365'; snout='#8b5e00'; ear='#5b3d00'; deco='stripes'; } if(selectedSkin==='super'){ body='#c7a087'; snout='#5f463a'; ear='#3b2b24'; deco='cape'; } if(selectedSkin==='neon'){ body='#111827'; snout='#0ea5e9'; ear='#22d3ee'; deco='glow'; } ctx.save(); ctx.translate(-r*0.2,r*1.0); ctx.scale(1,0.3); ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.beginPath(); ctx.ellipse(0,0,r*0.9,r*0.5,0,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.fillStyle=body; ctx.beginPath(); ctx.ellipse(0,0,r*1.1,r*0.9,0,0,Math.PI*2); ctx.fill(); ctx.fillStyle=snout; ctx.beginPath(); ctx.ellipse(r*0.35,-r*0.05,r*0.7,r*0.45,0,0,Math.PI*2); ctx.fill(); ctx.fillStyle=ear; ctx.beginPath(); ctx.arc(-r*0.3,-r*1.0,r*0.35,0,Math.PI*2); ctx.arc(r*0.55,-r*1.0,r*0.35,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-r*0.1,-r*0.25,r*0.18,0,Math.PI*2); ctx.arc(r*0.45,-r*0.25,r*0.18,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#1f2937'; ctx.beginPath(); ctx.arc(-r*0.1,-r*0.25,r*0.09,0,Math.PI*2); ctx.arc(r*0.45,-r*0.25,r*0.09,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#2b2b2b'; ctx.beginPath(); ctx.arc(r*0.2,-r*0.05,r*0.09,0,Math.PI*2); ctx.arc(r*0.55,-r*0.05,r*0.09,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#e0c9a6'; ctx.save(); ctx.translate(-r*0.4,0); ctx.rotate(-0.8+flap); ctx.beginPath(); ctx.ellipse(0,0,r*0.7,r*0.35,0,0,Math.PI*2); ctx.fill(); ctx.restore(); if(deco==='stripes'){ ctx.fillStyle='#00000033'; ctx.fillRect(-r*1.0,-r*0.6,r*2.0,r*0.2); ctx.fillRect(-r*1.0,0,r*2.0,r*0.2); } if(deco==='cape'){ ctx.fillStyle='rgba(239,68,68,0.85)'; ctx.beginPath(); ctx.moveTo(-r*0.6,-r*0.2); ctx.quadraticCurveTo(-r*1.2,r*0.3, -r*0.4,r*1.0); ctx.lineTo(r*0.2,r*0.8); ctx.closePath(); ctx.fill(); } if(deco==='glow'){ ctx.shadowBlur=18; ctx.shadowColor='#22d3ee'; }
    ctx.restore(); }

  const input={flap:false, hold:false};

  function startGame(){ reset(true); setState('playing'); if(audio && audio.state==='suspended') audio.resume().catch(()=>{}); }
  function gameOver(){ if(state!=='playing') return; setState('ready'); sfx.hit(); if(score>best){ best=score; bestEl.textContent=best; data.best=best; } save(data); }

  function loop(t){ const dt=Math.min(0.033,(t-(tPrev||t))/1000); tPrev=t; if(state==='playing') update(dt); draw(t); requestAnimationFrame(loop); }

  cvs.addEventListener('pointerdown', (e)=>{ e.preventDefault(); if (shop.classList.contains('show')) { return; } if(state!=='playing'){ startGame(); } else { input.flap=true; } input.hold=true; }, {passive:false});
  addEventListener('pointerup', ()=>{ input.hold=false; }, {passive:true});
  overlay.addEventListener('pointerdown', (e)=>{ e.preventDefault(); }, {passive:false});
  playBtn.addEventListener('click', (e)=>{ e.preventDefault(); startGame(); });

  addEventListener('keydown',(e)=>{ if (shop.classList.contains('show')) return; const k=e.key.toLowerCase(); if(k===' '||k==='arrowup'||k==='w'){ if(state!=='playing') startGame(); else input.flap=true; input.hold=true; e.preventDefault(); } if(k==='p'){ if(state==='playing'){ setState('pause'); overlay.querySelector('.title').textContent='–ü–∞—É–∑–∞'; overlay.querySelector('.subtitle').textContent='–ù–∞–∂–º–∏—Ç–µ –ò–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å'; } else if(state==='pause'){ setState('playing'); } } });
  addEventListener('keyup',(e)=>{ const k=e.key.toLowerCase(); if(k===' '||k==='arrowup'||k==='w'){ input.hold=false; } });

  pauseBtn.addEventListener('click', ()=>{ if(state==='playing'){ setState('pause'); overlay.querySelector('.title').textContent='–ü–∞—É–∑–∞'; overlay.querySelector('.subtitle').textContent='–ù–∞–∂–º–∏—Ç–µ –ò–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å'; } else if(state==='pause'){ setState('playing'); } });
  modeBtn.addEventListener('click', ()=>{ mode = mode==='tap'?'hold':'tap'; data.mode=mode; save(data); modeBtn.textContent = mode==='tap'?'üéÆ –¢–ê–ü':'üéÆ –£–î–ï–†–ñ–ê–ù–ò–ï'; });
  soundBtn.addEventListener('click', ()=>{ soundOn=!soundOn; data.sound=soundOn; save(data); soundBtn.textContent=soundOn?'üîä':'üîá'; });

  shopBtn.addEventListener('click', ()=>{ renderShop(); shop.classList.add('show'); });
  openShopBtn.addEventListener('click', ()=>{ renderShop(); shop.classList.add('show'); });
  closeShop.addEventListener('click', ()=> shop.classList.remove('show'));

  function renderShop(){
    const SKINS=[
      {id:'classic', name:'–ö–ª–∞—Å—Å–∏–∫–∞', price:0},
      {id:'bee', name:'–ü—á—ë–ª–∫–∞', price:60},
      {id:'super', name:'–°—É–ø–µ—Ä–º–æ–ø—Å', price:120},
      {id:'neon', name:'–ù–µ–æ–Ω', price:180}
    ];
    skinsGrid.innerHTML='';
    SKINS.forEach(s=>{
      const own=!!data.inv[s.id]; const active=(selectedSkin===s.id);
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">${s.name}</div><div class="price">üçñ ${s.price}</div></div><canvas width="160" height="90" style="width:100%;height:auto;border-radius:12px;border:1px solid var(--br)"></canvas><div style="display:flex;gap:8px;justify-content:flex-end">${own?`<button class=btn data-act=sel data-id=${s.id}>${active?'–í—ã–±—Ä–∞–Ω':'–í—ã–±—Ä–∞—Ç—å'}</button>`:`<button class=btn data-act=buy data-id=${s.id}>–ö—É–ø–∏—Ç—å</button>`}</div>`;
      skinsGrid.appendChild(card);
      const pv=card.querySelector('canvas'); const cx=pv.getContext('2d'); drawSkinPreview(cx,pv.width,pv.height,s.id);
    });
    skinsGrid.querySelectorAll('[data-act=buy]').forEach(b=>b.onclick=()=>{
      const id=b.getAttribute('data-id'); const price={bee:60,super:120,neon:180}[id]||0; if(food>=price){ food-=price; foodEl.textContent=food; data.food=food; data.inv[id]=true; save(data); selectedSkin=id; data.skin=id; save(data); renderShop(); } });
    skinsGrid.querySelectorAll('[data-act=sel]').forEach(b=>b.onclick=()=>{ selectedSkin=b.getAttribute('data-id'); data.skin=selectedSkin; save(data); renderShop(); });
  }

  function drawSkinPreview(cx,w,h,id){ cx.clearRect(0,0,w,h); cx.save(); cx.translate(w*0.5,h*0.6); const r=18; let body='#b08968', snout='#6d4c41', ear='#4b3f35'; if(id==='bee'){ body='#f6d365'; snout='#8b5e00'; ear='#5b3d00'; } if(id==='super'){ body='#c7a087'; snout='#5f463a'; ear='#3b2b24'; } if(id==='neon'){ body='#111827'; snout='#0ea5e9'; ear='#22d3ee'; } cx.fillStyle=body; cx.beginPath(); cx.ellipse(0,0,r*1.1,r*0.9,0,0,Math.PI*2); cx.fill(); cx.fillStyle=snout; cx.beginPath(); cx.ellipse(r*0.35,-r*0.05,r*0.7,r*0.45,0,0,Math.PI*2); cx.fill(); cx.fillStyle=ear; cx.beginPath(); cx.arc(-r*0.3,-r*1.0,r*0.35,0,Math.PI*2); cx.arc(r*0.55,-r*1.0,r*0.35,0,Math.PI*2); cx.fill(); cx.restore(); }

  function renderLB(){ const arr=[{name:'–í—ã',score:best}]; let html='<table><thead><tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th style="text-align:right">–û—á–∫–∏</th></tr></thead><tbody>'; arr.forEach((r,i)=>{ html+=`<tr><td>${i+1}</td><td>${r.name}</td><td style="text-align:right">${r.score}</td></tr>`; }); html+='</tbody></table>'; lbList.innerHTML=html; }
  lbClose.addEventListener('click', ()=> lb.classList.remove('show'));

  function draw(t){ ctx.clearRect(0,0,W,H); drawBg(t); for(const p of pipes) drawPipe(p); for(const f of kibble) drawFood(f,t); drawPug(t); ctx.save(); ctx.font='46px system-ui, -apple-system, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle='#0006'; ctx.fillText(score, W/2+2, 14+2); ctx.fillStyle='#fff'; ctx.fillText(score, W/2, 14); ctx.restore(); }

  function step(t){ const dt=Math.min(0.033,(t-(tPrev||t))/1000); tPrev=t; if(state==='playing') update(dt); draw(t); requestAnimationFrame(step); }

  resize(); reset(false); setState('ready'); requestAnimationFrame(step);
})();
</script>
</body>
</html>

